name: Check new version of amml-utils

on:
  workflow_dispatch:
  schedule:
    # Run this job every 4 hours
    - cron: "0 0/4 * * *"

permissions:
  contents: read
  issues: write 

jobs:
  fetch-tags:
    runs-on: ubuntu-latest
    outputs:
      comparison: ${{ steps.compare-versions.outputs.comparison-result }}
      new: ${{ steps.get-latest-version.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - id: get-latest-version
        name: Get the latest version
        uses: oprypin/find-latest-tag@v1
        with:
          repository: IDeaLab-uni-graz/amml-utils  # The repository to scan.
      - id: get-current-version
        name: Get the currently used version
        run: |
          VER=`grep -oE 'amml-utils.git@[0-9]+.[0-9]+.[0-9]+' slim_requirements.txt | awk -F"@" '{print (NF>1)? $NF : ""}'`
          echo "tag=$VER" >> $GITHUB_OUTPUT
      - uses: madhead/semver-utils@latest
        name: Compare versions
        id: compare-versions
        with:
          version: ${{ steps.get-current-version.outputs.tag }}
          compare-to: ${{ steps.get-latest-version.outputs.tag }}
  check-already-open:
    runs-on: ubuntu-latest
    needs: fetch-tags
    if: ${{ needs.fetch-tags.outputs.comparison == '<' }}
    outputs:
      issue-list: ${{ steps.check-issue.outputs.issues }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Check issue exists
        id: check-issue
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'find-issues'
          token: ${{ secrets.GITHUB_TOKEN }}
          title-includes: "[CI] New version ${{ needs.fetch-tags.outputs.new }} of amml-utils available!"
  open-issue:
    runs-on: ubuntu-latest
    needs:
      - fetch-tags
      - check-already-open
    if: ${{ needs.fetch-tags.outputs.comparison == '<' && needs.check-already-open.outputs.issue-list == '[]' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Create issue
        run: |
          new_issue_url=$(gh issue create \
            --title "$TITLE" \
            --assignee "$ASSIGNEES" \
            --label "$LABELS" \
            --body "$BODY")
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          TITLE: "[CI] New version ${{ needs.fetch-tags.outputs.new }} of amml-utils available!"
          ASSIGNEES: sceptri
          LABELS: dependencies
          BODY: |
            ### New `amml-utils` version

            Attention! New version of `amml-utils`, namely ${{ needs.fetch-tags.outputs.new }}, was found! We should update!

            > Note: This issue was generated automatically. Please report any issues to @sceptri.
